// manually creating the data of type java (json) for the motion chart
var data = [{
        "name": "East Asia & Pacific",
        "region": "East Asia & Pacific",
        "population": [
            [2000, 2045719304],
            [2001, 2064256190],
            [2002, 2081838347],
            [2003, 2098591772],
            [2004, 2114733687],
            [2005, 2130532480],
            [2006, 2146003642],
            [2007, 2160752291],
            [2008, 2175660860],
            [2009, 2190177014],
            [2010, 2204603357],
            [2011, 2219099361],
            [2012, 2233925733],
            [2013, 2248909163],
            [2014, 2264058207]
    ], 
        "lifeExpectancy": [
            [2000, 71.39],
            [2001, 71.76],
            [2002, 72.12],
            [2003, 72.46],
            [2004, 72.79],
            [2005, 73.06],
            [2006, 73.34],
            [2007, 73.58],
            [2008, 73.80],
            [2009, 74.02],
            [2010, 74.19],
            [2011, 74.35],
            [2012, 74.55],
            [2013, 74.74],
            [2014, 74.93]
    ],
        "gdp": [
            [2000, 8123810615617],
            [2001, 7558788091252],
            [2002, 7688845195207],
            [2003, 8454649250834],
            [2004, 9482314200450],
            [2005, 10095963405729],
            [2006, 10719924071846],
            [2007, 12017044907374],
            [2008, 13859361240763],
            [2009, 14266092173115],
            [2010, 16646691111278],
            [2011, 19273060936197],
            [2012, 20639939934217],
            [2013, 20854948941187],
            [2014, 21467980438307]
    ]
}, {
        "name": "Europe & Central Asia",
        "region": "Europe & Central Asia",
        "population": [
            [2000, 861962323],
            [2001, 863464756],
            [2002, 865165049],
            [2003, 867444690],
            [2004, 870039128],
            [2005, 872691148],
            [2006, 875386168],
            [2007, 878398727],
            [2008, 881895816],
            [2009, 885550281],
            [2010, 889046791],
            [2011, 892467445],
            [2012, 894249380],
            [2013, 899572111],
            [2014, 901978575]
    ], 
        "lifeExpectancy": [
            [2000, 73.02],
            [2001, 73.34],
            [2002, 73.40],
            [2003, 73.51],
            [2004, 73.94],
            [2005, 74.09],
            [2006, 74.57],
            [2007, 74.92],
            [2008, 75.17],
            [2009, 75.55],
            [2010, 75.84],
            [2011, 76.37],
            [2012, 76.56],
            [2013, 76.79],
            [2014, 76.89]
    ],
        "gdp": [
            [2000, 9925562058489],
            [2001, 10032194932465],
            [2002, 10979001413361],
            [2003, 13382990678394],
            [2004, 15605965132081],
            [2005, 16622711281309],
            [2006, 17995939923015],
            [2007, 21037510725765],
            [2008, 23096069362154],
            [2009, 20329892575827],
            [2010, 20833169212840],
            [2011, 22937131867929],
            [2012, 22008064602331],
            [2013, 22951201156421],
            [2014, 23183777043004]
    ]
}, {
    "name": "Latin America & Caribbean",
        "region": "Latin America & Caribbean",
        "population": [
            [2000, 525886558],
            [2001, 533449671],
            [2002, 540884684],
            [2003, 548225528],
            [2004, 555515431],
            [2005, 562783235],
            [2006, 570029991],
            [2007, 577248307],
            [2008, 584435842],
            [2009, 591577623],
            [2010, 598662941],
            [2011, 605674766],
            [2012, 612617659],
            [2013, 619487209],
            [2014, 626269527]
    ], 
        "lifeExpectancy": [
            [2000, 71.51],
            [2001, 71.83],
            [2002, 72.13],
            [2003, 72.41],
            [2004, 72.67],
            [2005, 72.92],
            [2006, 73.15],
            [2007, 73.38],
            [2008, 73.60],
            [2009, 73.82],
            [2010, 74.04],
            [2011, 74.26],
            [2012, 74.49],
            [2013, 74.71],
            [2014, 74.94],
    ],
        "gdp": [
            [2000, 2263130225780],
            [2001, 2205568775012],
            [2002, 1977354954128],
            [2003, 2037300320655],
            [2004, 2368638258036],
            [2005, 2867409575251],
            [2006, 3366096540635],
            [2007, 3978237572380],
            [2008, 4621168880663],
            [2009, 4344426603213],
            [2010, 5373441134711],
            [2011, 6087975652209],
            [2012, 6169327651783],
            [2013, 6345519376542],
            [2014, 6253493117689]
    ]
}, {
    "name": "Middle East & North Africa",
        "region": "Middle East & North Africa",
        "population": [
            [2000, 315152002],
            [2001, 321230141],
            [2002, 327306993],
            [2003, 333494898],
            [2004, 339941989],
            [2005, 346735318],
            [2006, 353923119],
            [2007, 361451154],
            [2008, 369228612],
            [2009, 377133473],
            [2010, 384945112],
            [2011, 393003905],
            [2012, 401144535],
            [2013, 409324396],
            [2014, 417451788]
    ], 
        "lifeExpectancy": [
            [2000, 69.74],
            [2001, 70.01],
            [2002, 70.26],
            [2003, 70.49],
            [2004, 70.73],
            [2005, 70.95],
            [2006, 71.19],
            [2007, 71.41],
            [2008, 71.63],
            [2009, 71.86],
            [2010, 72.07],
            [2011, 72.26],
            [2012, 72.44],
            [2013, 72.63],
            [2014, 72.82]
    ],
        "gdp": [
            [2000, 961691134198],
            [2001, 965250458459],
            [2002, 961443148947],
            [2003, 1082750053478],
            [2004, 1258781818295],
            [2005, 1517131605864],
            [2006, 1776265999918],
            [2007, 2110398484126],
            [2008, 2636340485393],
            [2009, 2350793490211],
            [2010, 2736460934534],
            [2011, 3280166467260],
            [2012, 3550021490730],
            [2013, 3576594801386],
            [2014, 3520091046667]
    ]
}, {
        "name": "North America",
        "region": "North America",
        "population": [
            [2000, 312993944],
            [2001, 316113359],
            [2002, 319050105],
            [2003, 321847258],
            [2004, 324864038],
            [2005, 327892753],
            [2006, 331014940],
            [2007, 334184023],
            [2008, 337405012],
            [2009, 340465736],
            [2010, 343417455],
            [2011, 346128976],
            [2012, 348928352],
            [2013, 351718031],
            [2014, 354465895]
    ], 
        "lifeExpectancy": [
            [2000, 66.66],
            [2001, 66.98],
            [2002, 67.28],
            [2003, 67.59],
            [2004, 67.89],
            [2005, 68.18],
            [2006, 68.47],
            [2007, 68.76],
            [2008, 69.03],
            [2009, 69.32],
            [2010, 69.59],
            [2011, 69.85],
            [2012, 70.10],
            [2013, 70.34],
            [2014, 70.58]
    ],
        "gdp": [
            [2000, 11027715147894],
            [2001, 11358221425149],
            [2002, 11733982930033],
            [2003, 12402608291469],
            [2004, 13297813932823],
            [2005, 14262738384226],
            [2006, 15172055119875],
            [2007, 15941401754545],
            [2008, 16267310484701],
            [2009, 15795385199538],
            [2010, 16584130197731],
            [2011, 17312273132799],
            [2012, 18001411134432],
            [2013, 18612590885409],
            [2014, 19210139300922]
    ]
}, {
        "name": "South Asia",
        "region": "South Asia",
        "population": [
            [2000, 1386406570],
            [2001, 1411288216],
            [2002, 1436509869],
            [2003, 1461691023],
            [2004, 1486610311],
            [2005, 1511135613],
            [2006, 1535287611],
            [2007, 1559056624],
            [2008, 1582576481],
            [2009, 1605926788],
            [2010, 1629223562],
            [2011, 1652487921],
            [2012, 1675019307],
            [2013, 1698093032],
            [2014, 1721152580]
    ], 
        "lifeExpectancy": [
            [2000, 62.91],
            [2001, 63.30],
            [2002, 63.69],
            [2003, 64.07],
            [2004, 64.44],
            [2005, 64.80],
            [2006, 65.18],
            [2007, 65.55],
            [2008, 65.93],
            [2009, 66.31],
            [2010, 66.70],
            [2011, 67.07],
            [2012, 67.44],
            [2013, 67.79],
            [2014, 68.12]
    ],
        "gdp": [
            [2000, 629218213749],
            [2001, 645830778947],
            [2002, 679729515374],
            [2003, 793221517960],
            [2004, 919797959629],
            [2005, 1053910008265],
            [2006, 1204953472747],
            [2007, 1526158574232],
            [2008, 1552632048542],
            [2009, 1706841276033],
            [2010, 2093718920591],
            [2011, 2284614000522],
            [2012, 2301943612415],
            [2013, 2361515495718],
            [2014, 2588688024255]
    ]
    }, {
        "name": "Sub-Saharan Africa",
        "region": "Sub-Saharan Africa",
        "population": [
            [2000, 667742098],
            [2001, 685795280],
            [2002, 704102354],
            [2003, 722925207],
            [2004, 742396040],
            [2005, 762555740],
            [2006, 783427658],
            [2007, 805010175],
            [2008, 827287676],
            [2009, 850225069],
            [2010, 873800152],
            [2011, 898002051],
            [2012, 922840423],
            [2013, 948287652],
            [2014, 974315197]
    ], 
        "lifeExpectancy": [
            [2000, 50.34],
            [2001, 50.62],
            [2002, 51.00],
            [2003, 51.49],
            [2004, 52.06],
            [2005, 52.72],
            [2006, 53.43],
            [2007, 54.18],
            [2008, 54.93],
            [2009, 55.65],
            [2010, 56.34],
            [2011, 56.97],
            [2012, 57.55],
            [2013, 58.08],
            [2014, 58.56]
    ],
        "gdp": [
            [2000, 362910349544],
            [2001, 337643820425],
            [2002, 363597131427],
            [2003, 465146666702],
            [2004, 578127924150],
            [2005, 683807337957],
            [2006, 798705220927],
            [2007, 920818950602],
            [2008, 1049509664538],
            [2009, 996042982341],
            [2010, 1336840906464],
            [2011, 1510556040409],
            [2012, 1582355692308],
            [2013, 1667560287073],
            [2014, 1745241568844]
    ]
}];

function y(d) {
	return d.lifeExpectancy;
}

function x(d) {
	return d.gdp;
}

function radius(d) {
	return d.population;
}

function color(d) {
	return d.region;
}

function key(d) {
	return d.name;
}

var region = ""; // default constructor 

var margin = { //dimension
    top: 19.5,
    right: 19.5,
    bottom: 19.5,
    left: 39.5
},
width = 960 - margin.right,
    height = 500 - margin.top - margin.bottom,
    yearMargin = 10;

// defining the range for the scale of x axis and y axis, as well as the scale for the radius
var xScale = d3.scale.linear().domain([300000000000, 30000000000000]).range([0, width - yearMargin]),
    yScale = d3.scale.linear().domain([45, 80]).range([height, 0]),
    radiusScale = d3.scale.linear().domain([300000000, 3000000000]).range([5, 60]),
    colorScale = d3.scale.category20(); // using cat20 as the default categorical color for the circles

// Defining the x and y acis
formatter = d3.format(".0"); //default formatter
var xAxis = d3.svg.axis().orient("bottom").scale(xScale).ticks(6, d3.format(",d")), //defining prop for scale - 7 ticks
    yAxis = d3.svg.axis().scale(yScale).orient("left").tickFormat(formatter);

//boxwork container for the svg
var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// place x axis in the container, translate it, distaince is 0, touch the y axis
svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

// place y axis in the container
svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);

// places label on the x axis
svg.append("text")
    .attr("class", "x label")
    .attr("text-anchor", "end")
    .attr("x", width)
    .attr("y", height - 2)
    .text("GDP"); // add label for the X axis

// Label for y axis
svg.append("text")
    .attr("class", "y label")
    .attr("text-anchor", "end")
    .attr("y", 6)
    .attr("dy", ".75em") // distance between text and y-axis
    .attr("transform", "rotate(-90)") // rotate label so it's vertical
    .text("Life Expectancy (Year)"); // add label for the y axis

// transition
var label = svg.append("text")
    .attr("class", "year label")
    .attr("text-anchor", "end")
    .attr("y", height - 24)
    .attr("x", width)
    .text(2000); // places the year label

// places text for the region representation
var country = svg.append("text")
    .attr("class", "country")
    .attr("y", height - margin.bottom)
    .attr("x", margin.left)
    .text("");

// load data
draw(data);

function draw(nations) {

    var regions = "";

    // bisector
    var bisect = d3.bisector(function (d) {
        return d[0];
    });

    // add the circle for all region, set default to 2000
    var tooltip = d3.select("body")
        .append("div")
        .style("position", "absolute") //allow overaly
        .style("z-index", "10")
        .style("visibility", "hidden") // hide
        // .text("tooltop");

    // tooltip.text("tooltip");

    var dots = svg.append("g")
        .attr("class", "dots"); //circle to represent the region

    var dot = dots.selectAll(".dot") // places the circle
        .data(interpolateData(2000)) //default at 2000
        .enter().append("circle")
        .attr("class", "dot")
        .style("fill", function (d) {
        return colorScale(color(d)); 
    })
        // creating the tooltip for hover over, defining what the user sees
        .on("mouseover", function (d) { 
        tooltip.html("<b>Country Region:</b> " + d.name + "<br><b>Life Expectancy:</b> " + d.lifeExpectancy.toFixed(2) + "<br><b>GDP:</b></br>" +  d.gdp.toFixed(0) + "<br><b>Population:</b></br>" + d.population.toFixed(0));
        tooltip.attr('class', 'd3-tip');
        return tooltip.style("visibility", "visible"); //show
    })
        .on("mousemove", function (d) {
        tooltip.html("<strong>Country Region:</strong> " + d.name + "<br><b>Life Expectancy:</b> " + d.lifeExpectancy.toFixed(2) + "<br><b>GDP:</b></br>" +  d.gdp.toFixed(0) + "<br><b>Population:</b></br>" + d.population.toFixed(0));
        return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); // follow the tooltip, show only when clicked
    })
        .on("mouseout", function (d) {
        return tooltip.style("visibility", "hidden"); //upon hoveroff of the circle, hide
    })
        .on("click", function (d) { // selects region, click on circle
        if (region === d.name) {
            region = ""; //default constructor
        } else {
            region = d.name;
        }
        country.text(region); //places text on the bottom, sets opacity factor when clicked.
        dot.style("opacity", function (d) {
            return region === "" && regions.indexOf(d.name) != -1 || region === d.name ? 1.0 : 0.1;
        });
    })
        .call(position)
        .sort(order);


    // Add an overlay for year text
    var box = label.node().getBBox();

    var overlay = svg.append("rect") //overaly of type rectangle
        .attr("class", "overlay")
        .attr("x", box.x)
        .attr("y", box.y)
        .attr("width", box.width)
        .attr("height", box.height)
        .on("mouseover", permitInteraction);

    // Sets the timer for the duration of the transitioning
    svg.transition()
        .duration(25000)
        .ease("linear")
        .tween("year", tweenYear)
        .each("end", permitInteraction);

    // places the circle on the graph based on the gdp and life expectancy
    function position(dot) {
        dot.attr("cx", function (d) {
            return xScale(x(d));
        })
            .attr("cy", function (d) {
            return yScale(y(d));
        })
            .attr("r", function (d) {
            return radiusScale(radius(d));
        });
    }

    // if circles overlay, the smallest circle is placed on top
    function order(a, b) {
        return radius(b) - radius(a);
    }

    // Allow interaction after the transition ends
    function permitInteraction() {
        var yearScale = d3.scale.linear()
            .domain([2000, 2014]) // year 2000 to 2014
            .range([box.x + 10, box.x + box.width - 10])
            .clamp(true);


        // discontinue the automatic transition if cursor hovers over the year text
        svg.transition().duration(0);

        overlay.on("mouseover", mouseover)
            .on("mouseout", mouseout)
            .on("mousemove", mousemove)
            .on("touchmove", mousemove);

        function mouseover() {
            label.classed("active", true);
        }

        function mouseout() {
            label.classed("active", false);
        }

        function mousemove() {
            displayYear(yearScale.invert(d3.mouse(this)[0]));
        }
    }
    // tweens entire chart by year then data
    // redraw circle for interpolated data
    function tweenYear() {
        var year = d3.interpolateNumber(2000, 2014);
        return function (t) {
            displayYear(year(t));
        };
    }

    // update chart to show the year selected on the text
    function displayYear(year) {
        dot.data(interpolateData(year), key).call(position).sort(order);
        label.text(Math.round(year));
    }
    // Interpolates the data
    function interpolateData(year) {
        return nations.map(function (d) {
            return {
                name: d.name,
                region: d.region,
                lifeExpectancy: interpolateValues(d.lifeExpectancy, year),
                population: interpolateValues(d.population, year),
                gdp: interpolateValues(d.gdp, year)
            };
        });
    }

    // locates value for the specified year from data
    function interpolateValues(values, year) {
        var i = bisect.left(values, year, 0, values.length - 1),
            a = values[i];
        if (i > 0) {
            var b = values[i - 1],
                t = (year - a[0]) / (b[0] - a[0]);
            return a[1] * (1 - t) + b[1] * t;
        }
        return a[1];
    }
}

    $(function() {
      $("#refresh").click(function(evt) {
         $("#chart").load("index.html #chart")
         evt.preventDefault();
      })
    })